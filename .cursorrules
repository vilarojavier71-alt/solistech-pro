üåå MPE-OS V3.0.0 ELITE QUANTUM-SENTINEL - ROOT RULESET

Prioridad M√°xima: ISO 27001, Pentesting Red Team, Seguridad Cu√°ntica (PQC), FinOps Guardrails y Excelencia UX/A11y.

---

üß† 1. GENERAL AI BEHAVIOR & AGENTIC ARCHITECTURE

Context & MCP Awareness:
- Antes de proponer cambios, usa @Codebase y servidores MCP para verificar dependencias y documentaci√≥n en tiempo real.
- Consulta la estructura del proyecto y archivos relacionados antes de modificar c√≥digo.

Think First:
- Analiza el impacto arquitect√≥nico aplicando SOLID, Clean Architecture y GoF antes de escribir una sola l√≠nea.
- Eval√∫a el impacto en m√≥dulos relacionados y dependencias.

Simulaci√≥n Cr√≠tica:
- Realiza simulaciones (dry-run) obligatorias antes de ejecutar cambios que afecten al n√∫cleo del sistema.
- Valida cambios en transacciones financieras, autenticaci√≥n y autorizaci√≥n.

Regla de Refactorizaci√≥n (20 L√≠neas):
- Si una funci√≥n supera las 20 l√≠neas, sugiere refactorizar autom√°ticamente para mantener la modularidad.
- Extrae l√≥gica de negocio a funciones puras, hooks personalizados o utilidades reutilizables.
- Prioriza composici√≥n sobre herencia.

Agentic Logic:
- Dise√±a m√≥dulos con entradas claras y salidas JSON estructuradas para facilitar el consumo por otros agentes de IA.
- Documenta interfaces y contratos de datos.

Documentation "Why":
- Genera JSDoc/Docstrings explicando el "por qu√©" de la decisi√≥n t√©cnica, no solo el "qu√©".
- El c√≥digo debe ser auto-explicativo con nombres descriptivos.

---

üõ°Ô∏è 2. ISO 27001 & MASTER CYBERSECURITY (ZERO TRUST)

Cifrado PQC (Post-Quantum Cryptography):
- Implementa AES-256-GCM en reposo y TLS 1.3 en tr√°nsito.
- Usa algoritmos resistentes a cu√°ntica (ML-KEM/Kyber, ML-DSA/Dilithium) cuando sea t√©cnicamente posible.
- Prioriza librer√≠as con soporte PQC para secretos de larga duraci√≥n.

Integridad de Datos:
- Validaci√≥n estricta con Zod o Valibot en cada punto de entrada de datos (API, Forms, DB).
- Nunca conf√≠es en datos del cliente sin validar.
- Usa esquemas estrictos con `.strict()` en Zod.

User Flag Protection (Zero-Flag Policy):
- PROHIBIDO exponer flags de privilegios (isAdmin, role, isPremium) en el cliente o en respuestas de API.
- El frontend solo debe recibir booleanos de "permiso de acci√≥n" (ej. canEdit: true).
- Nunca expongas nombres de roles internos al cliente.

Permission Masking:
- Env√≠a solo booleanos de "permiso de acci√≥n" (ej. canEdit: true, canDelete: false).
- Nunca env√≠es el nombre del rol interno (admin, owner, god_mode).
- Implementa checks de permisos en el servidor, no en el cliente.

Secret Management:
- Prohibido el hardcoding de secretos, API keys o tokens.
- Usa variables de entorno con validaci√≥n en runtime.
- Para Prisma, usa ApiKeyVault para secretos cifrados, mostrando solo los √∫ltimos 4 caracteres como maskedValue.
- Exige registro en .env.example (sin valores reales).

Audit Trail:
- Todo cambio cr√≠tico de estado debe generar un log estructurado e inmutable.
- Incluye: timestamp, source, action, userId, resourceId, error (si aplica).
- Usa formato JSON para logs estructurados.

---

üìä 3. TYPESCRIPT & TYPE SAFETY

TypeScript Strict Mode:
- Configuraci√≥n strict: true obligatoria.
- Cero uso de `any`. Usa `unknown` y gen√©ricos para tipado din√°mico.
- Valida tipos en runtime con Zod cuando sea necesario.

Type Guards:
- Implementa type guards para validar datos desconocidos.
- Usa discriminated unions para estados complejos.

---

‚öôÔ∏è 4. SQL & DATABASE BEST PRACTICES

SQL Standards:
- Palabras clave en MAY√öSCULAS (SELECT, INSERT, UPDATE, DELETE, WHERE, etc.).
- Nombres de tablas/columnas en snake_case.
- Usa Prisma ORM cuando sea posible, pero respeta estos est√°ndares en queries raw.

Optimizaci√≥n de Consultas:
- Usa siempre EXPLAIN ANALYZE para evitar el problema N+1.
- Selecciona solo los campos necesarios (evita SELECT *).
- Implementa √≠ndices en campos de b√∫squeda frecuente.

Race Conditions:
- Usa SELECT FOR UPDATE en transacciones cr√≠ticas que involucren balances o recursos compartidos.
- Implementa transacciones at√≥micas con Prisma.$transaction para operaciones financieras.
- Valida ownership de recursos antes de modificar.

---

üí∞ 5. FINOPS GUARDRAILS

Accounting Autom√°tico:
- Cada acci√≥n de infraestructura debe disparar un asiento contable autom√°tico (ej. DEBIT 622x / CREDIT 4000).
- Registra costos de recursos cloud, APIs externas y servicios de terceros.

Cost Guardrails:
- Bloquea escalados autom√°ticos o acciones si gastoActual + costeEstimado > presupuestoMensual.
- Implementa alertas cuando el gasto supere el 80% del presupuesto mensual.
- Valida presupuesto antes de crear recursos costosos.

---

üß™ 6. TESTING & QUALITY

TDD & AAA:
- El test se escribe antes que la funci√≥n siguiendo el patr√≥n Arrange-Act-Assert.
- Prioriza tests unitarios para l√≥gica de negocio.
- Tests E2E para flujos cr√≠ticos de usuario.

Stress Testing:
- Genera tests de carga para endpoints cr√≠ticos.
- Simula latencia o fallos de DB para verificar la autorrecuperaci√≥n.

Fuzzy Testing:
- Env√≠a inputs aleatorios y malformados para asegurar la robustez de los tipos y la validaci√≥n.

---

üßπ 7. LEGACY CLEANUP & SSOT

Zombie Code Removal:
- Elimina c√≥digo comentado, funciones no utilizadas y archivos basura (.bak, _old, legacy/) sin piedad.
- Usa herramientas de an√°lisis est√°tico para detectar c√≥digo muerto.

Single Source of Truth (SSOT):
- Unifica READMEs y documentos de arquitectura.
- Si el c√≥digo y la documentaci√≥n discrepan, el c√≥digo es la verdad y la documentaci√≥n se actualiza o borra.
- Mant√©n un solo README principal en la ra√≠z.

---

üìù 8. AGENTIC WORKFLOW PROMPTS

Auditor√≠a Total:
"Act√∫a como Pentester y Arquitecto. Escanea el codebase buscando vulnerabilidades PQC, brechas ISO 27001, fugas de secretos y fallos de l√≥gica econ√≥mica."

Pentest Estricto:
"Ataca este m√≥dulo buscando IDOR, SSRF e inyecciones l√≥gicas. Revisa el √°rbol de dependencias para Supply Chain attacks."

Limpieza Pre-V1:
"Ejecuta el protocolo SSOT: unifica documentos, borra c√≥digo zombie y purga archivos innecesarios para la v1.0 oficial."

An√°lisis de Coste:
"Revisa esta l√≥gica buscando potenciales fugas econ√≥micas o de recursos (loops infinitos, llamadas API sin l√≠mite)."


