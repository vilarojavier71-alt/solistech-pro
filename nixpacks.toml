# ============================================================================
# NIXPACKS CONFIGURATION - SOLISTECH PRO
# ============================================================================
# Fixes Coolify/Nixpacks for Next.js with output: 'standalone'
# Memory limit prevents OOM during build on low-RAM VPS
# CACHE_BUSTER: 2024-12-17T18:30:00 - Force clean rebuild
# ============================================================================

# Force Node.js provider
providers = ["node"]

[phases.setup]
# Note: npm is bundled with nodejs, not a separate package in Nix
nixPkgs = ["nodejs_20"]

[phases.install]
cmds = ["npm ci --legacy-peer-deps"]

[phases.build]
# Prisma generate + Build with 3.5GB memory limit
# Then copy static assets required for standalone mode
cmds = [
    "npx prisma generate",
    "NODE_OPTIONS='--max-old-space-size=3584' npm run build",
    "cp -r .next/static .next/standalone/.next/static",
    "cp -r public .next/standalone/public"
]

[start]
# With output: 'standalone', must use node server.js (not npm start)
cmd = "node .next/standalone/server.js"

