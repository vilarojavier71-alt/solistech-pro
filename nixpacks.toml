# ============================================================================
# NIXPACKS CONFIGURATION - SOLISTECH PRO
# ============================================================================
# Fixes Coolify/Nixpacks for Next.js with output: 'standalone'
# Memory limit prevents OOM during build on low-RAM VPS
# CACHE_BUSTER: 2024-12-17T18:35:00 - Fix static files path
# ============================================================================

# Force Node.js provider
providers = ["node"]

[phases.setup]
# Note: npm is bundled with nodejs, not a separate package in Nix
nixPkgs = ["nodejs_20"]
# OpenSSL required for Prisma
aptPkgs = ["openssl", "ca-certificates"]

[phases.install]
# Fix npm permissions in containerized environments
cmds = [
    "mkdir -p /tmp/.npm",
    "NPM_CONFIG_CACHE=/tmp/.npm NPM_CONFIG_TMP=/tmp HOME=/app npm ci --legacy-peer-deps --no-audit --no-fund"
]

[phases.build]
# Prisma generate + Build with 4GB memory limit
# Then copy static assets to correct locations for standalone mode
cmds = [
    "npx prisma generate",
    "NODE_OPTIONS='--max-old-space-size=4096' npm run build",
    "mkdir -p .next/standalone/.next",
    "cp -r .next/static .next/standalone/.next/static",
    "cp -r public .next/standalone/public"
]

[start]
# Run from the standalone directory
cmd = "cd .next/standalone && node server.js"


