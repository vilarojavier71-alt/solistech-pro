üåå MPE-OS V3.0.0 - INFRASTRUCTURE & DEVOPS RULESET

Prioridad: Resiliencia, Seguridad, Anti-Ban, Docker Excellence.

---

üê≥ 1. DOCKER EXCELLENCE

Multi-Stage Builds:
- Usa multi-stage builds para reducir el tama√±o de las im√°genes finales.
- Separa dependencias de build de dependencias de runtime.
- Optimiza layers para mejor cacheo.

Non-Root Execution:
- Ejecuta contenedores como usuario no-root.
- Crea usuario espec√≠fico en Dockerfile (ej. `RUN adduser -D -u 1000 appuser`).
- Usa `USER appuser` antes de ejecutar la aplicaci√≥n.

Base Images:
- Prioriza im√°genes Alpine o Distroless para reducir superficie de ataque.
- Evita im√°genes basadas en Ubuntu/Debian completas cuando sea posible.
- Mant√©n im√°genes base actualizadas (security patches).

HEALTHCHECK Obligatorio:
- Implementa HEALTHCHECK en todos los Dockerfiles.
- Usa endpoints de health check ligeros (no dependientes de DB pesada).
- Timeout razonable (30s-60s).

Ejemplo:
```dockerfile
FROM node:20-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

FROM node:20-alpine
RUN adduser -D -u 1000 appuser
WORKDIR /app
COPY --from=builder /app/node_modules ./node_modules
COPY . .
USER appuser
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD node -e "require('http').get('http://localhost:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"
CMD ["npm", "start"]
```

---

üîÑ 2. RESILIENCE & FAILOVER

Circuit Breaker:
- Implementa failover autom√°tico entre proveedores (ej. Hetzner -> Netcup) tras 3 fallos consecutivos.
- Timeout configurable para detecci√≥n de fallos.
- Estado de circuit breaker: CLOSED, OPEN, HALF_OPEN.

Health Monitoring:
- Endpoints de health check en todas las aplicaciones.
- Monitoreo de recursos (CPU, memoria, disco).
- Alertas autom√°ticas cuando recursos superen umbrales (80% CPU, 90% memoria).

Backup Strategy:
- Formato de backup: `backup-[ID]-[VER]-[TS]` (ej. `backup-db-v1-20250120T120000Z`).
- Cifrado con AES-256-GCM.
- Pol√≠tica de poda autom√°tica por espacio (mantener √∫ltimos N backups o √∫ltimos X d√≠as).
- Verificaci√≥n de integridad de backups antes de eliminar.

---

üõ°Ô∏è 3. ANTI-BAN 2.0

Rate Limiting Din√°mico:
- Implementa rate limiting con ventana deslizante.
- L√≠mites por IP, usuario y endpoint.
- Tarpitting: aumentar latencia progresivamente tras m√∫ltiples intentos.

User-Agent Rotation:
- Rota User-Agents en peticiones salientes a APIs externas.
- Pool de User-Agents realistas (navegadores modernos).
- Evita patrones detectables.

ICMP Desactivaci√≥n:
- Desactiva respuestas ICMP (ping) en servidores de producci√≥n cuando sea posible.
- Reduce la huella de ataque y dificulta el reconocimiento.

Ejemplo de Rate Limiting:
```typescript
// Rate limiting con Redis o in-memory store
const rateLimiter = new RateLimiter({
  windowMs: 60 * 1000, // 1 minuto
  max: 100, // 100 requests por minuto
  standardHeaders: true,
  legacyHeaders: false,
  handler: (req, res) => {
    logStructured({
      timestamp: new Date().toISOString(),
      source: 'rate_limiter',
      action: 'rate_limit_exceeded',
      ip: req.ip,
      error: 'Too many requests'
    })
    res.status(429).json({ error: 'Too many requests' })
  }
})
```

---

üîí 4. SECURITY HARDENING

Secrets Management:
- Nunca hardcodees secretos en Dockerfiles o c√≥digo.
- Usa Docker secrets o variables de entorno inyectadas en runtime.
- Rotaci√≥n peri√≥dica de secretos (cada 90 d√≠as recomendado).

Network Security:
- A√≠sla contenedores en redes internas cuando sea posible.
- No expongas puertos innecesarios al host.
- Usa reverse proxy (Caddy/Nginx) para TLS termination.

Image Scanning:
- Escanea im√°genes Docker en busca de vulnerabilidades (Trivy, Snyk).
- Integra escaneo en CI/CD pipeline.
- Bloquea despliegues si se encuentran vulnerabilidades cr√≠ticas.

---

üìä 5. MONITORING & OBSERVABILITY

Structured Logging:
- Logs en formato JSON estructurado.
- Incluye: timestamp, level, source, message, context.
- Centraliza logs (ELK, Loki, CloudWatch).

Metrics:
- M√©tricas de aplicaci√≥n (Prometheus format).
- M√©tricas de infraestructura (CPU, memoria, disco, red).
- Dashboards en Grafana o similar.

Alerting:
- Alertas para:
  - Errores cr√≠ticos (>5% error rate)
  - Recursos agotados (CPU >80%, memoria >90%)
  - Fallos de health check
  - Anomal√≠as de tr√°fico

---

üöÄ 6. CI/CD & DEPLOYMENT

CI/CD Pipeline:
- Tests autom√°ticos en cada commit (unit, integration, E2E).
- Linting y type checking obligatorios.
- Build de im√°genes Docker en CI.
- Escaneo de seguridad antes de deploy.

Deployment Strategy:
- Blue-Green o Canary deployments para producci√≥n.
- Rollback autom√°tico si health check falla tras deploy.
- Feature flags para activaci√≥n gradual de funcionalidades.

---

üßπ 7. CLEANUP & OPTIMIZATION

Resource Cleanup:
- Elimina im√°genes Docker no utilizadas peri√≥dicamente (`docker image prune`).
- Limpia vol√∫menes hu√©rfanos.
- Poda de logs antiguos (retention policy).

Optimization:
- Minimiza n√∫mero de layers en Dockerfile.
- Usa .dockerignore para excluir archivos innecesarios.
- Cachea dependencias eficientemente (package.json antes de c√≥digo fuente).

---

üìù 8. DOCUMENTATION

Infrastructure as Code:
- Documenta toda la infraestructura (Docker Compose, Kubernetes manifests).
- Versiona configuraciones de infraestructura.
- README con instrucciones de despliegue y troubleshooting.

Runbooks:
- Documenta procedimientos de:
  - Despliegue
  - Rollback
  - Escalado
  - Recuperaci√≥n ante desastres


