generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
  // Binary targets: native for dev, debian-openssl for Docker slim
  binaryTargets   = ["native", "debian-openssl-3.0.x", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USERS & AUTH (NextAuth compatible)
// ============================================================================

model User {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email           String   @unique
  password_hash   String?
  full_name       String?
  avatar_url      String?
  role            String?  @default("employee")
  department      String?
  organization_id String?  @db.Uuid
  email_verified  Boolean? @default(false)
  is_test_admin   Boolean? @default(false)
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  updated_at      DateTime @default(now()) @db.Timestamptz(6)

  organization           Organization?          @relation(fields: [organization_id], references: [id])
  accounts               Account[]
  sessions               Session[]
  customers              Customer[]
  projects               Project[]
  assigned_projects      Project[]              @relation("assigned_projects")
  assigned_leads         Lead[]
  time_entries           TimeEntry[]
  invoices               Invoice[]
  gmail_token            GmailToken?
  accounting_journals    AccountingJournal[]
  phase_changes          ProjectPhaseHistory[]
  processed_transactions ProjectTransaction[]  @relation("processed_transactions")
  uploaded_documents     ProjectDocument[]     @relation("uploaded_documents")
  reviewed_documents     ProjectDocument[]     @relation("reviewed_documents")
  assigned_appointments  Appointment[]
  created_invitations    Invitation[]
  client_portal_project  Project?               @relation("client_portal_project")
  support_tickets        SupportTicket[]
  audit_logs             AuditLog[]
  import_jobs            ImportJob[]
  subsidy_applications_created SubsidyApplication[] @relation("subsidy_created_by")

  @@index([organization_id, role])
  @@index([email])
  @@map("users")
}

model Organization {
  id                     String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                   String
  slug                   String    @unique
  logo_url               String?
  tax_id                 String?
  address                Json?
  phone                  String?
  email                  String?
  // Subscription fields
  subscription_status    String?   @default("basic") // basic, active, past_due, canceled
  subscription_plan      String?   @default("basic") // basic, pro
  stripe_customer_id     String?
  stripe_subscription_id String?
  max_employees          Int       @default(0) // 0 = basic plan (no employees)
  current_employee_count Int       @default(0)
  subscription_ends_at   DateTime? @db.Timestamptz(6)
  is_god_mode            Boolean   @default(false)
  created_at             DateTime? @default(now()) @db.Timestamptz(6)
  updated_at             DateTime? @default(now()) @db.Timestamptz(6)

  users               User[]
  customers           Customer[]
  leads               Lead[]
  projects            Project[]
  invoices            Invoice[]
  subscriptions       Subscription[]
  settings            OrganizationSettings?
  operating_expenses  OperatingExpense[]
  inventory_items     InventoryItem[]
  accounting_accounts AccountingAccount[]
  accounting_journals AccountingJournal[]
  sales               Sale[]
  appointment         Appointment[]

  invitations Invitation[]

  // New stabilization tables
  payment_methods PaymentMethod[]
  calculations    Calculation[]
  presentations   Presentation[]
  support_tickets SupportTicket[]

  // Leave management tables
  employee_leave_balances EmployeeLeaveBalance[]
  import_jobs             ImportJob[]
  leave_requests          LeaveRequest[]

  // Audit logs (ISO 27001)
  audit_logs              AuditLog[]

  // Subsidy applications
  subsidy_applications    SubsidyApplication[]

  @@index([subscription_plan, subscription_status])
  @@map("organizations")
}

model OrganizationSettings {
  id                        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organization_id           String    @unique @db.Uuid
  ai_provider               String?
  ai_api_key_encrypted      String?
  ai_api_key_valid          Boolean?  @default(false)
  ai_api_key_last_validated DateTime?
  presentation_template     String?   @default("ebro-solar")
  default_fiscal_deduction  String?   @default("40")
  created_at                DateTime  @default(now()) @db.Timestamptz(6)
  updated_at                DateTime  @default(now()) @db.Timestamptz(6)

  organization Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)

  @@map("organization_settings")
}

// Subscription history and tracking
// Subscription history and tracking
model Subscription {
  id                     String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organization_id        String   @db.Uuid
  stripe_subscription_id String   @unique
  stripe_price_id        String
  status                 String // active, past_due, canceled, trialing
  current_period_start   DateTime @db.Timestamptz(6)
  current_period_end     DateTime @db.Timestamptz(6)
  cancel_at_period_end   Boolean  @default(false)
  created_at             DateTime @default(now()) @db.Timestamptz(6)
  updated_at             DateTime @default(now()) @db.Timestamptz(6)

  organization Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

// ============================================================================
// NEXTAUTH TABLES (Auth.js compatible naming)
// ============================================================================

model Account {
  id                String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String  @map("user_id") @db.Uuid
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id") @db.Uuid
  expires      DateTime @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime @db.Timestamptz(6)

  @@id([identifier, token])
  @@map("verification_tokens")
}

// ============================================================================
// BUSINESS TABLES
// ============================================================================

model Customer {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organization_id   String?  @db.Uuid
  created_by        String?  @db.Uuid
  name              String
  email             String?
  phone             String?
  nif               String?
  address           String?
  city              String?
  postal_code       String?
  province          String?
  country           String?
  notes             String?
  custom_attributes Json?    @default("{}")
  status            String?  @default("active")
  is_active         Boolean? @default(true)
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  updated_at        DateTime @default(now()) @db.Timestamptz(6)

  organization           Organization?          @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  created_by_user        User?                  @relation(fields: [created_by], references: [id], onDelete: SetNull)
  projects               Project[]
  invoices               Invoice[]
  appointments           Appointment[]
  presentations          Presentation[]
  subsidy_applications   SubsidyApplication[]

  @@index([organization_id, name])
  @@index([organization_id, email])
  @@index([organization_id, nif])
  @@map("customers")
}

model Lead {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organization_id String   @db.Uuid
  name            String
  email           String?
  phone           String?
  company         String?
  source          String?  @default("web") // web, referral, cold_call, etc.
  status          String   @default("new") // new, contacted, qualified, proposal, won, lost
  estimated_value Decimal? @db.Decimal(12, 2)
  notes           String?
  assigned_to     String?  @db.Uuid
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  updated_at      DateTime @default(now()) @db.Timestamptz(6)

  organization  Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  assigned_user User?         @relation(fields: [assigned_to], references: [id], onDelete: SetNull)

  @@index([organization_id, status])
  @@map("leads")
}

model Project {
  id                       String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organization_id          String?   @db.Uuid
  client_id                String?   @db.Uuid
  name                     String
  description              String?
  installation_type        String?
  status                   String?   @default("quote")
  system_size_kwp          Decimal?  @db.Decimal
  estimated_production_kwh Decimal?  @db.Decimal
  estimated_savings        Decimal?  @db.Decimal
  location                 Json?
  cadastral_reference      String?
  cadastral_data           Json?
  created_by               String?   @db.Uuid
  // Portal Cliente - Campos de seguimiento
  installation_phase       Int       @default(0) // 0-7 fases
  legalization_status      String?   @default("pending")
  installation_date        DateTime? @db.Date
  activation_date          DateTime? @db.Date
  expected_completion      DateTime? @db.Date
  client_portal_enabled    Boolean   @default(false)
  client_access_token      String?
  assigned_technician_id   String?   @db.Uuid
  phase_notes              String?
  portal_user_id           String?   @unique @db.Uuid // [PROJECT ISOLATION] One client user, one project
  // Solar Core - Campos de negocio
  solar_phase              String    @default("DRAFT") // DRAFT, PHASE_0A, PHASE_1_DOCS, PHASE_2_REVIEW, APPROVED, CORRECTIONS
  payment_status           String    @default("PENDING") // PENDING, PAID, REFUNDED
  total_amount             Decimal?  @db.Decimal(12, 2) // CRÍTICO: No usar Float
  engineer_verdict         Json? // { verdict: "OK"|"REJECT", reason?: string, reviewed_at: Date }
  contract_url             String?
  // Campos de fecha de proyecto
  start_date               DateTime? @db.Date
  end_date                 DateTime? @db.Date
  grant_calculation        Json?
  created_at               DateTime  @default(now()) @db.Timestamptz(6)
  updated_at               DateTime  @default(now()) @db.Timestamptz(6)

  organization        Organization?          @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  customer            Customer?              @relation(fields: [client_id], references: [id], onDelete: Cascade)
  created_by_user     User?                   @relation(fields: [created_by], references: [id])
  assigned_technician User?                   @relation("assigned_projects", fields: [assigned_technician_id], references: [id])
  portal_user         User?                   @relation("client_portal_project", fields: [portal_user_id], references: [id])
  time_entries        TimeEntry[]
  invoices            Invoice[]
  phase_history       ProjectPhaseHistory[]
  transactions        ProjectTransaction[]
  documents           ProjectDocument[]
  calculations        Calculation[]
  presentations       Presentation[]

  @@index([organization_id, status])
  @@index([location])
  @@index([client_id, client_portal_enabled])
  @@index([organization_id, created_at])
}

model TimeEntry {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id            String    @db.Uuid
  project_id         String?   @db.Uuid
  clock_in           DateTime  @db.Timestamptz(6)
  clock_out          DateTime? @db.Timestamptz(6)
  lat_in             Decimal?  @db.Decimal
  lng_in             Decimal?  @db.Decimal
  address_in         String?
  lat_out            Decimal?  @db.Decimal
  lng_out            Decimal?  @db.Decimal
  address_out        String?
  total_minutes      Int?
  is_verified        Boolean?  @default(false)
  verification_notes String?
  status             String?   @default("active")
  created_at         DateTime  @default(now()) @db.Timestamptz(6)

  user    User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [project_id], references: [id], onDelete: SetNull)

  @@map("time_entries")
}

model Invoice {
  id                   String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organization_id      String?   @db.Uuid
  invoice_number       String
  sequential_number    Int?
  customer_id          String?   @db.Uuid
  project_id           String?   @db.Uuid
  customer_name        String?
  customer_nif         String?
  customer_address     String?
  customer_city        String?
  customer_postal_code String?
  customer_email       String?
  issue_date           DateTime  @default(now()) @db.Date
  due_date             DateTime? @db.Date
  status               String?   @default("draft")
  payment_status       String?   @default("pending")
  subtotal             Decimal?  @default(0) @db.Decimal(12, 2)
  tax_amount           Decimal?  @default(0) @db.Decimal(12, 2)
  total                Decimal?  @default(0) @db.Decimal(12, 2)
  notes                String?
  internal_notes       String?
  created_by           String?   @db.Uuid
  created_at           DateTime  @default(now()) @db.Timestamptz(6)
  updated_at           DateTime  @default(now()) @db.Timestamptz(6)

  organization    Organization?  @relation(fields: [organization_id], references: [id])
  customer        Customer?      @relation(fields: [customer_id], references: [id], onDelete: Restrict)
  project         Project?       @relation(fields: [project_id], references: [id], onDelete: SetNull)
  created_by_user User?           @relation(fields: [created_by], references: [id])
  lines           InvoiceLine[]

  @@unique([organization_id, invoice_number])
  @@index([organization_id, status])
  @@index([issue_date])
  @@index([organization_id, due_date])
  @@map("invoices")
}

model InvoiceLine {
  id                  String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  invoice_id          String   @db.Uuid
  line_order          Int
  description         String
  quantity            Decimal  @default(1) @db.Decimal(10, 2)
  unit_price          Decimal  @default(0) @db.Decimal(12, 2)
  discount_percentage Decimal? @default(0) @db.Decimal(5, 2)
  discount_amount     Decimal? @default(0) @db.Decimal(12, 2)
  tax_rate            Decimal? @default(21) @db.Decimal(5, 2)
  tax_amount          Decimal? @default(0) @db.Decimal(12, 2)
  subtotal            Decimal  @db.Decimal(12, 2)
  total               Decimal  @db.Decimal(12, 2)

  invoice Invoice @relation(fields: [invoice_id], references: [id], onDelete: Cascade)

  @@map("invoice_lines")
}

// ============================================================================
// FINANCE & INVENTORY (GAP ANALYSIS FIXES)
// ============================================================================

model OperatingExpense {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organization_id String   @db.Uuid
  description     String
  amount          Decimal  @db.Decimal(12, 2)
  category        String // Office, Equipment, Marketing, etc.
  date            DateTime @db.Date
  receipt_url     String?
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  updated_at      DateTime @default(now()) @db.Timestamptz(6)

  organization Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)

  @@index([organization_id, date])
  @@map("operating_expenses")
}

model InventoryItem {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organization_id String   @db.Uuid
  name            String
  sku             String?
  category        String?
  quantity        Int      @default(0)
  min_quantity    Int?     @default(5)
  unit_price      Decimal? @db.Decimal(12, 2)
  location        String?
  notes           String?
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  updated_at      DateTime @default(now()) @db.Timestamptz(6)

  organization Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)

  @@index([organization_id, sku])
  @@map("inventory_items")
}

// ============================================================================
// RBAC SYSTEM (ROLES & PERMISSIONS)
// ============================================================================

model Permission {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  slug        String   @unique // e.g. "users:view", "invoices:create"
  description String?
  created_at  DateTime @default(now()) @db.Timestamptz(6)

  roles RolePermission[]

  @@map("permissions")
}

model RolePermission {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  role            String // e.g. "admin", "owner", "ingeniero"
  permission_slug String
  created_at      DateTime @default(now()) @db.Timestamptz(6)

  permission Permission @relation(fields: [permission_slug], references: [slug], onDelete: Cascade)

  @@unique([role, permission_slug])
  @@index([role])
  @@map("role_permissions")
}

// ============================================================================
// ACCOUNTING / DOUBLE-ENTRY BOOKKEEPING
// ============================================================================

model AccountingAccount {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organization_id String   @db.Uuid
  code            String
  name            String
  type            String // asset, liability, equity, revenue, expense
  parent_id       String?  @db.Uuid
  is_group        Boolean  @default(false)
  is_active       Boolean  @default(true)
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  updated_at      DateTime @default(now()) @db.Timestamptz(6)

  organization Organization             @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  parent       AccountingAccount?      @relation("AccountHierarchy", fields: [parent_id], references: [id])
  children     AccountingAccount[]     @relation("AccountHierarchy")
  transactions AccountingTransaction[]

  @@unique([organization_id, code])
  @@index([organization_id, type])
  @@map("accounting_accounts")
}

model AccountingJournal {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organization_id String   @db.Uuid
  date            DateTime @db.Date
  description     String
  reference       String?
  status          String   @default("draft") // draft, posted, void
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  updated_at      DateTime @default(now()) @db.Timestamptz(6)
  created_by      String?  @db.Uuid

  organization    Organization             @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  created_by_user User?                     @relation(fields: [created_by], references: [id])
  transactions    AccountingTransaction[]

  @@index([organization_id, date])
  @@index([organization_id, status])
  @@map("accounting_journals")
}

model AccountingTransaction {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  journal_id  String   @db.Uuid
  account_id  String   @db.Uuid
  debit       Decimal  @default(0) @db.Decimal(20, 2)
  credit      Decimal  @default(0) @db.Decimal(20, 2)
  description String?
  created_at  DateTime @default(now()) @db.Timestamptz(6)

  journal AccountingJournal @relation(fields: [journal_id], references: [id], onDelete: Cascade)
  account AccountingAccount @relation(fields: [account_id], references: [id], onDelete: Restrict)

  @@index([journal_id])
  @@index([account_id])
  @@map("accounting_transactions")
}

// ============================================================================
// GMAIL INTEGRATION (Encrypted Tokens)
// ============================================================================

model GmailToken {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id       String   @unique @db.Uuid
  access_token  String // Encrypted
  refresh_token String // Encrypted (Critical)
  scope         String
  email         String
  expires_at    BigInt
  is_active     Boolean  @default(true)
  created_at    DateTime @default(now()) @db.Timestamptz(6)
  updated_at    DateTime @default(now()) @db.Timestamptz(6)

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)
  @@map("gmail_tokens")
}

// ============================================================================
// PORTAL CLIENTE - Historial de Fases
// ============================================================================

model ProjectPhaseHistory {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  project_id String   @db.Uuid
  from_phase Int?
  to_phase   Int
  changed_by String   @db.Uuid
  notes      String?
  created_at DateTime @default(now()) @db.Timestamptz(6)

  project Project @relation(fields: [project_id], references: [id], onDelete: Cascade)
  user    User     @relation(fields: [changed_by], references: [id])

  @@index([project_id, created_at(sort: Desc)])
  @@map("project_phase_history")
}

// ============================================================================
// SOLAR CORE - Transacciones Financieras
// ============================================================================

model ProjectTransaction {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  project_id      String   @db.Uuid
  amount          Decimal  @db.Decimal(12, 2)
  transaction_ref String   @unique // Referencia bancaria única
  payment_method  String? // transfer, card, cash
  notes           String?
  processed_by    String   @db.Uuid
  created_at      DateTime @default(now()) @db.Timestamptz(6)

  project Project @relation(fields: [project_id], references: [id], onDelete: Cascade)
  user    User     @relation("processed_transactions", fields: [processed_by], references: [id])

  @@index([project_id, created_at(sort: Desc)])
  @@map("project_transactions")
}

// ============================================================================
// SOLAR CORE - Documentos de Proyecto (Flujo Ping-Pong)
// ============================================================================

model ProjectDocument {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  project_id       String    @db.Uuid
  type             String // DNI, FACTURA_LUZ, CONTRATO, CIE, OTRO
  status           String    @default("PENDING") // PENDING, UPLOADED, REJECTED, APPROVED
  url              String? // URL del archivo subido
  file_name        String?
  rejection_reason String? // Feedback del ingeniero si es rechazado
  uploaded_by      String?   @db.Uuid
  reviewed_by      String?   @db.Uuid
  uploaded_at      DateTime?
  reviewed_at      DateTime?
  created_at       DateTime  @default(now()) @db.Timestamptz(6)
  updated_at       DateTime  @default(now()) @db.Timestamptz(6)

  project  Project @relation(fields: [project_id], references: [id], onDelete: Cascade)
  uploader User?    @relation("uploaded_documents", fields: [uploaded_by], references: [id])
  reviewer User?    @relation("reviewed_documents", fields: [reviewed_by], references: [id])

  @@index([project_id, type])
  @@index([project_id, status])
  @@map("project_documents")
}

// ============================================================================
// LEGACY TABLES RECOVERY (MIGRATION FIXES)
// ============================================================================

model Sale {
  id                   String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organization_id      String?   @db.Uuid
  customer_id          String?   @db.Uuid
  customer_name        String?
  dni                  String?
  customer_email       String?
  customer_phone       String?
  sale_number          String?
  amount               Decimal?  @db.Decimal(12, 2)
  material             String?
  created_by           String?   @db.Uuid
  sale_date            DateTime? @db.Timestamptz(6)
  payment_method       String?
  payment_terms        String?
  payment_status       String?   @default("pending")
  documentation_status String?   @default("pending")
  engineering_status   String?   @default("pending")
  process_status       String?   @default("not_started")
  installation_status  String?   @default("pending")
  documentation_notes  String?
  access_code          String?
  canvasser_id         String?
  created_at           DateTime  @default(now()) @db.Timestamptz(6)
  updated_at           DateTime  @default(now()) @db.Timestamptz(6)

  organization Organization? @relation(fields: [organization_id], references: [id], onDelete: Cascade)

  @@index([organization_id, sale_number])
  @@map("sales")
}

model Appointment {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organization_id String?   @db.Uuid
  title           String?
  description     String?
  start_time      DateTime? @db.Timestamptz(6)
  end_time        DateTime? @db.Timestamptz(6)
  customer_id     String?   @db.Uuid
  assigned_to     String?   @db.Uuid
  created_by      String?   @db.Uuid
  address         String?
  status          String?   @default("scheduled")
  created_at      DateTime  @default(now()) @db.Timestamptz(6)
  updated_at      DateTime  @default(now()) @db.Timestamptz(6)

  organization Organization? @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  customer     Customer?     @relation(fields: [customer_id], references: [id], onDelete: Cascade)
  assignee     User?          @relation(fields: [assigned_to], references: [id], onDelete: SetNull)

  @@index([organization_id, start_time])
  @@map("appointments")
}

model ClientNotification {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sale_id           String    @db.Uuid
  title             String
  message           String
  notification_type String // info, success, warning, error, action_required
  action_label      String?
  action_url        String?
  read              Boolean   @default(false)
  read_at           DateTime? @db.Timestamptz(6)
  sent_email        Boolean   @default(false)
  sent_sms          Boolean   @default(false)
  sent_push         Boolean   @default(false)
  created_at        DateTime  @default(now()) @db.Timestamptz(6)

  @@map("client_notifications")
}

// ============================================================================
// INVITATION SYSTEM (Client Onboarding)
// ============================================================================

model Invitation {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organization_id String   @db.Uuid
  token           String   @unique // 6-8 chars alphanumeric
  email           String?
  role            String   @default("client")
  status          String   @default("pending") // pending, used, revoked
  expires_at      DateTime @db.Timestamptz(6)
  created_by      String   @db.Uuid
  created_at      DateTime @default(now()) @db.Timestamptz(6)

  organization Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  creator      User          @relation(fields: [created_by], references: [id], onDelete: Cascade)

  @@index([organization_id, status])
  @@index([token])
  @@map("invitations")
}

// ============================================================================
// MISSING TABLES (STABILIZATION FIXES)
// ============================================================================

model PaymentMethod {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organization_id String   @db.Uuid
  name            String
  instructions    String?
  is_default      Boolean  @default(false)
  is_active       Boolean  @default(true)
  details         Json?
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  updated_at      DateTime @default(now()) @db.Timestamptz(6)

  organization Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)

  @@index([organization_id, is_active])
  @@map("payment_methods")
}

model Calculation {
  id                       String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organization_id          String   @db.Uuid
  project_id               String?  @db.Uuid
  name                     String?
  system_size_kwp          Decimal? @db.Decimal(10, 2)
  estimated_production_kwh Decimal? @db.Decimal(12, 2)
  estimated_savings        Decimal? @db.Decimal(12, 2)
  location                 Json?
  components               Json?
  pvgis_data               Json?
  subsidy_irpf_type        String?  @default("40")
  created_at               DateTime @default(now()) @db.Timestamptz(6)
  updated_at               DateTime @default(now()) @db.Timestamptz(6)

  organization Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  project      Project?     @relation(fields: [project_id], references: [id], onDelete: SetNull)

  @@index([organization_id])
  @@index([project_id])
  @@map("calculations")
}

model Presentation {
  id                    String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organization_id       String   @db.Uuid
  customer_id           String?  @db.Uuid
  project_id            String?  @db.Uuid
  title                 String
  status                String   @default("draft") // draft, generating, completed, failed
  original_photo_url    String?
  simulated_photo_url   String?
  powerpoint_url        String?
  fiscal_deduction_type String?
  created_by            String?  @db.Uuid
  created_at            DateTime @default(now()) @db.Timestamptz(6)
  updated_at            DateTime @default(now()) @db.Timestamptz(6)

  organization Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  customer     Customer?    @relation(fields: [customer_id], references: [id], onDelete: SetNull)
  project      Project?     @relation(fields: [project_id], references: [id], onDelete: SetNull)

  @@index([organization_id, project_id])
  @@map("presentations")
}

// ============================================================================
// SUPPORT TICKETS (Help Center)
// ============================================================================

model SupportTicket {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organization_id   String    @db.Uuid
  user_id           String    @db.Uuid
  customer_id       String?   @db.Uuid // Link to customer if incident from import
  subject           String
  description       String    @db.Text
  category          String // facturacion, tecnico, solar, general, import_incident
  status            String    @default("open") // open, in_analysis, intervention, resolved, closed
  priority          String    @default("normal") // low, normal, high, urgent
  source_page       String? // /dashboard/calculator, /dashboard/projects, etc.
  source_type       String? // manual, import_excel, system_alert
  assigned_to       String?   @db.Uuid // Technician assigned
  sla_deadline      DateTime? @db.Timestamptz(6) // SLA deadline for response
  first_response_at DateTime? @db.Timestamptz(6) // When first response was sent
  resolved_at       DateTime? @db.Timestamptz(6) // When marked as resolved
  created_at        DateTime  @default(now()) @db.Timestamptz(6)
  updated_at        DateTime  @updatedAt @db.Timestamptz(6)

  organization Organization     @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  user         User              @relation(fields: [user_id], references: [id], onDelete: Cascade)
  messages     TicketMessage[]

  @@index([organization_id, status])
  @@index([user_id])
  @@index([customer_id])
  @@index([assigned_to])
  @@index([status, priority])
  @@map("support_tickets")
}

model TicketMessage {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ticket_id   String    @db.Uuid
  sender_id   String    @db.Uuid
  sender_role String // client, technician, admin, system
  content     String    @db.Text
  is_internal Boolean   @default(false) // Internal notes not visible to client
  attachments Json? // Array of attachment URLs
  read_at     DateTime? @db.Timestamptz(6)
  created_at  DateTime  @default(now()) @db.Timestamptz(6)

  ticket SupportTicket @relation(fields: [ticket_id], references: [id], onDelete: Cascade)

  @@index([ticket_id, created_at])
  @@index([sender_id])
  @@map("ticket_messages")
}

// ============================================================================
// LEAVE MANAGEMENT (Gestión de Vacaciones y Días Libres)
// ============================================================================

model EmployeeLeaveBalance {
  id              String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id         String @unique @db.Uuid
  organization_id String @db.Uuid
  year            Int // Año fiscal del saldo

  // Vacaciones reglamentarias (días laborables)
  vacation_days_total   Decimal @default(22) @db.Decimal(5, 2) // Total anual según convenio
  vacation_days_used    Decimal @default(0) @db.Decimal(5, 2) // Días gastados
  vacation_days_pending Decimal @default(0) @db.Decimal(5, 2) // Días en solicitudes pendientes

  // Días de libre disposición / Asuntos propios
  personal_days_total Decimal @default(3) @db.Decimal(5, 2)
  personal_days_used  Decimal @default(0) @db.Decimal(5, 2)

  // Días remunerados adicionales (permisos por convenio)
  paid_days_total Decimal @default(0) @db.Decimal(5, 2)
  paid_days_used  Decimal @default(0) @db.Decimal(5, 2)

  // Metadatos
  hire_date     DateTime? @db.Date // Fecha de alta (para cálculo proporcional)
  contract_type String? // indefinido, temporal, parcial
  notes         String?   @db.Text

  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @updatedAt @db.Timestamptz(6)

  organization Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)

  @@unique([user_id, year])
  @@index([organization_id, year])
  @@map("employee_leave_balances")
}

model LeaveRequest {
  id              String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id         String @db.Uuid
  organization_id String @db.Uuid

  // Tipo de ausencia
  leave_type String // vacation, personal, paid, sick, unpaid, other

  // Período solicitado
  start_date     DateTime @db.Date
  end_date       DateTime @db.Date
  days_requested Decimal  @db.Decimal(5, 2) // Puede ser 0.5 para medias jornadas

  // Estado y aprobación
  status           String  @default("pending") // pending, approved, rejected, cancelled
  reason           String? @db.Text // Motivo de la solicitud
  rejection_reason String? @db.Text // Motivo del rechazo

  // Aprobación
  approved_by String?   @db.Uuid
  approved_at DateTime? @db.Timestamptz(6)

  // Auditoría
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @updatedAt @db.Timestamptz(6)

  organization Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)

  @@index([user_id, status])
  @@index([organization_id, status])
  @@index([start_date, end_date])
  @@map("leave_requests")
}

// ============================================================================
// AUDIT LOGS (ISO 27001 A.8.15 Compliance)
// ============================================================================

model AuditLog {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  event_type     String    @db.VarChar(100)
  user_id        String    @db.Uuid
  organization_id String?  @db.Uuid
  resource_type  String    @db.VarChar(100)
  resource_id    String    @db.Uuid
  action         String    @db.VarChar(255)
  metadata       Json?
  ip_address     String?   @db.Inet
  user_agent     String?   @db.Text
  timestamp      DateTime  @default(now()) @db.Timestamptz(6)

  user         User           @relation(fields: [user_id], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organization_id], references: [id], onDelete: SetNull)

  @@index([user_id])
  @@index([organization_id])
  @@index([event_type])
  @@index([resource_type, resource_id])
  @@index([timestamp(sort: Desc)])
  @@index([user_id, timestamp(sort: Desc)])
  @@index([organization_id, timestamp(sort: Desc)])
  @@map("audit_logs")
}


model ImportJob {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organization_id String    @db.Uuid
  entity_type     String
  file_name       String
  total_rows      Int       @default(0)
  processed_rows  Int       @default(0)
  successful_rows Int       @default(0)
  failed_rows     Int       @default(0)
  skipped_rows    Int       @default(0)
  status          String    @default("pending")
  column_mapping  Json?
  errors          Json?
  started_at      DateTime? @db.Timestamptz(6)
  completed_at    DateTime? @db.Timestamptz(6)
  created_by      String    @db.Uuid
  created_at      DateTime  @default(now()) @db.Timestamptz(6)

  organization Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [created_by], references: [id], onDelete: Cascade)

  @@index([organization_id, created_at])
  @@map("import_jobs")
}

// ============================================================================
// SUBSIDY APPLICATIONS (Tramitación de Subvenciones)
// ============================================================================

model SubsidyApplication {
  id                   String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organization_id      String    @db.Uuid
  customer_id          String    @db.Uuid
  created_by           String?   @db.Uuid
  
  // Application details
  application_number   String    @unique
  status               String    @default("collecting_docs") // collecting_docs, ready_to_submit, submitted, approved, rejected
  subsidy_type         String    @default("ibi") // ibi, icio, irpf, regional, national
  region               String    // Autonomous community
  province             String?
  municipality         String?
  
  // Amounts
  estimated_amount     Decimal?  @db.Decimal(12, 2)
  approved_amount      Decimal?  @db.Decimal(12, 2)
  project_cost         Decimal?  @db.Decimal(12, 2)
  
  // Dates
  submission_deadline  DateTime? @db.Timestamptz(6)
  submitted_at         DateTime? @db.Timestamptz(6)
  approved_at          DateTime? @db.Timestamptz(6)
  rejected_at          DateTime? @db.Timestamptz(6)
  
  // Documents
  required_docs        Json?     @default("[]") // Array of {name, uploaded, file_url}
  
  // Notes
  notes                String?
  rejection_reason     String?
  
  created_at           DateTime  @default(now()) @db.Timestamptz(6)
  updated_at           DateTime  @default(now()) @db.Timestamptz(6)

  organization Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  customer     Customer     @relation(fields: [customer_id], references: [id], onDelete: Cascade)
  created_by_user User?     @relation("subsidy_created_by", fields: [created_by], references: [id], onDelete: SetNull)

  @@index([organization_id, status])
  @@index([organization_id, customer_id])
  @@index([submission_deadline])
  @@map("subsidy_applications")
}
